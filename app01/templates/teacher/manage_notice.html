{% extends 'teacher/teacher_layout.html' %}
{% load static %}

{% block content %}
    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box justify-content-between d-flex align-items-md-center flex-md-row flex-column">
                            <h4 class="page-title">é€šçŸ¥</h4>
                            <ol class="breadcrumb m-0">

                            </ol>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-12">
                        <div class="timeline" dir="ltr">
                            <button id="btnAdd" class="btn btn-success btn-function" data-bs-toggle="modal"
                                    data-bs-target="#signup-modal">
                                å‘å¸ƒé€šçŸ¥
                            </button>
                            <!-- å‘å¸ƒæ—¶é—´ -->
                            <div class="timeline-show mb-3 text-center">
                            </div>

                            <!-- å‘å¸ƒçš„å†…å®¹ -->
                            {% for notice in notices %}
                                {% if forloop.counter|divisibleby:2 %}
                                    <div class="timeline-lg-item timeline-item-right">
                                {% else %}
                                    <div class="timeline-lg-item timeline-item-left">
                                {% endif %}
                            <div class="timeline-desk">
                                <div class="timeline-box">
                                    <span class="arrow-alt"></span>
                                    <span class="timeline-icon bg-danger-subtle"><i
                                            class="ri-record-circle-fill text-danger"></i></span>
                                    <h2 class="mt-0 mb-1 fs-30">{{ notice.title }}</h2>
                                    <p class="text-muted"><small>{{ notice.created_at|date:"Y-m-d H:i:s" }}</small></p>
                                    <p class="mt-0 mb-1 fs-16">{{ notice.content|safe }}</p>
                                    <a href="javascript: void(0);" class="btn btn-sm btn-light">ğŸ‘</a>
                                </div>
                            </div>
                            </div>
                            {% endfor %}

                            <!-- å‘å¸ƒé€šçŸ¥æ¨¡æ€æ¡† -->
                            <div id="signup-modal" class="modal fade" tabindexs="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title" id="multiple-oneModalLabel">æ–°å¢</h4>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="addForm" action="#" novalidate
                                                  class="ps-3 pe-3">

                                                {% for field in form %}
                                                    <div class="mb-3" style="position: relative">
                                                        <label class="form-label">{{ field.label }}</label>
                                                        {{ field }}
                                                        <span class="s_error"
                                                              style="color:red;position: absolute">{{ field.errors.0 }}</span>
                                                    </div>
                                                {% endfor %}
                                                <div class="mb-3 text-center">
                                                    <button type="button" class="btn rounded-pill btn-light"
                                                            data-bs-dismiss="modal">å…³é—­
                                                    </button>

                                                    <input type="button" class="btn rounded-pill btn-primary"
                                                           id="btnSave" value="ä¿å­˜"/>
                                                </div>
                                            </form>
                                        </div>
                                    </div><!-- /.modal-content -->
                                </div><!-- /.modal-dialog -->
                            </div><!-- /.modal -->

                            </div>
                            <!-- end timeline -->
                        </div> <!-- end col -->
                    </div>
                    <!-- end row -->

                </div> <!-- container -->

            </div> <!-- content -->

            <!-- Footer Start -->
            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <script>document.write(new Date().getFullYear())</script>
                            Â© HUAT - www.huat.edu.cn
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end footer-links d-none d-md-block">
                                <a href="javascript: void(0);">å…³äº</a>
                                <a href="javascript: void(0);">æ”¯æŒ</a>
                                <a href="javascript: void(0);">è”ç³»æˆ‘ä»¬</a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
            <!-- end Footer -->

        </div>
    </div>
{% endblock %}
{% block js %}
    <script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
    <script type="text/javascript">
        let EDIT_ID = null;
        $(function () {
            // ç‚¹å‡»åˆ é™¤çš„æ–¹æ³•
            bindBtnDelete();
            // ç¡®è®¤åˆ é™¤
            bindBtmConfirmDelete();
            // ç”±äºã€ç¼–è¾‘ã€‘å’Œã€æ–°å¢ã€‘æ˜¯ç”¨çš„åŒä¸€ä¸ªæ¨¡æ€æ¡†ï¼Œæ‰€ä»¥å¾—å¯¹ä»–ä»¬è¿›è¡Œåˆ¤æ–­
            binBtnSave();
            // æ·»åŠ æ–°å‘˜å·¥ -- æ¨¡æ€æ¡†
            bindBtnAddEvent();
            binBtnEdit();
        })


        // ä¿å­˜æŒ‰é’®å‡½æ•°ï¼šåˆ¤æ–­å½“å‰EDIT_IDçš„å€¼ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è¿›è¡Œç¼–è¾‘å‡½æ•°ï¼Œå¦‚æœä¸ºç©ºåˆ™è¿›è¡Œæ·»åŠ å‡½æ•°
        function binBtnSave() {
            $('#btnSave').click(function () {
                $(".s_error").empty();
                if (EDIT_ID) {
                    doEdit();
                } else {
                    doAdd();
                }
            })
        }

        // å…·ä½“å®ç°æ–°å¢çš„å‡½æ•° doAdd
        function doAdd() {
            $.ajax({
                url: '/teacher_add/notice/',
                type: 'post',
                data: $('#addForm').serialize(),
                dataType: 'JSON',
                success: function (res) {
                    if (res.status) {
                        alert('æ·»åŠ æˆåŠŸï¼')
                        location.reload();
                    } else {
                        $.each(res.error, function (name, data) {
                            $('#id_' + name).next().text(data[0])
                        })
                    }
                }
            })
        }

        // æ·»åŠ æ–°å‘˜å·¥ -- æ¨¡æ€æ¡†
        function bindBtnAddEvent() {
            $('.btn-function').click(function () {
                $(".s_error").empty();
                // é¦–å…ˆå°†ç¼–è¾‘çš„idç½®ç©º å› ä¸ºç¼–è¾‘å’Œæ–°å¢ç”¨çš„æ˜¯ç”¨ä¸€ä¸ªæ¨¡æ€æ¡†
                EDIT_ID = undefined;
                // æ–°å¢ä¹‹å‰å…ˆæ¸…é™¤æ¨¡æ€æ¡†è¡¨å•å†…å®¹
                $('#addForm')[0].reset()
            })
        }

        // è·å–å½“å‰è¦ç¼–è¾‘çš„ç­çº§çš„æ•°æ®
        function binBtnEdit() {
            $('.btnEdit').click(function () {
                // ç¼–è¾‘ä¹‹å‰å…ˆæ¸…é™¤ä¹‹å‰æ¨¡æ€æ¡†è¡¨å•å†…å®¹
                $('#addForm')[0].reset();
                EDIT_ID = $(this).data('eid');
                // alert(EDIT_ID)
                $.ajax({
                    url: '/get/classes/edit_detail/',
                    type: 'get',
                    data: {
                        eid: EDIT_ID
                    },
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            $('#multiple-oneModalLabel').text('ç¼–è¾‘')
                            // å°†åŸæœ¬çš„æ•°æ®åœ¨ç¼–è¾‘æ¡†ä¸Šæ˜¾ç¤ºå‡ºæ¥
                            $.each(res.data, function (name, value) {
                                $('#id_' + name).val(value)
                                // ä¿®æ”¹æ ‡é¢˜æ–‡å­—
                            })
                        } else {
                            alert(res.error)
                        }
                    }
                })
            })
        }

        // ç¼–è¾‘ å‡½æ•°
        function doEdit() {
            $.ajax({
                url: '/teacher/classes_edit/' + '?eid=' + EDIT_ID,
                type: 'post',
                data: $('#addForm').serialize(),
                dataType: 'JSON',
                success: function (res) {
                    if (res.status) {
                        alert('ç¼–è¾‘æˆåŠŸï¼')
                        location.reload();
                    } else {
                        if (res.tips) {
                            alert(res.tips)
                        } else {
                            $.each(res.error, function (name, data) {
                                $('#id_' + name).next().text(data[0])
                            })
                        }

                    }
                }
            })
        }

        // ç‚¹å‡»åˆ é™¤æŒ‰é’®çš„åŒæ—¶è·å–å½“å‰id
        function bindBtnDelete() {
            $('body').on('click', '.btnDelete', function () {
                // è·å–å½“å‰è¿™ä¸€è¡Œçš„ id å¹¶ä¼ é€’ç»™ bindBtmConfirmDelete å‡½æ•°ä½¿ç”¨
                let deleteId = $(this).data('id');
                bindBtmConfirmDelete(deleteId);
            });
        }

        // ç¡®è®¤åˆ é™¤
        function bindBtmConfirmDelete(id) {
            $('#confirm_delete').click(function () {
                // å°† id å‘é€åˆ°åç«¯
                $.ajax({
                    url: '/teacher/classes/delete/',
                    method: "GET",
                    data: {
                        did: id
                    },
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            location.reload()
                        } else {
                            alert(res.error);
                            location.reload()
                        }
                    }
                })
            });
        }
    </script>
{% endblock %}